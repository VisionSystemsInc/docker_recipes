version: 2.1

# -----
# CircleCI custom commands
# -----
commands:

  # run "ci_load" command on user-selected docker-compose file
  # - requires environment variables $VSI_COMMON_DIR and $CACHE_REPO
  # - each service identified in the docker-compose file will be separately
  #   built via "${VSI_COMMON_DIR}/linux/ci_load.py"
  # - As we are building recipes themselves, we ignore the vsiri/recipe
  #   dockerhub repo by setting "--recipe-repo" to a dummy variable.
  ci_load:
    description: Build dockers (ci_load)
    parameters:
      step_name:
        description: Step name
        type: string
        default: Build recipes (ci_load)
      compose_file:
        description: docker-compose file
        type: string
    steps:
      - run:
          name: << parameters.step_name >>
          command: |
            COMPOSE_FILE="<< parameters.compose_file >>"
            SERVICES=( $(docker-compose -f "${COMPOSE_FILE}" ps --services) )
            for SERVICE in "${SERVICES[@]}"
            do
              python3 "${VSI_COMMON_DIR}/linux/ci_load.py" \
                --recipe-compose "./docker-compose.yml" \
                --recipe-repo "IGNORE-RECIPE-REPO" \
                --cache-repo "${CACHE_REPO}" \
                "${COMPOSE_FILE}" ${SERVICE}
            done

# -----
# CircleCI jobs
# -----
jobs:

  build_and_test:
    docker:
      - image: vsiri/circleci:bash-compose-lfs
    environment:
      VSI_COMMON_DIR: /vsi
      CACHE_REPO: vsiri/ci_cache_recipes
    shell: /bin/bash -eo pipefail
    working_directory: ~/repo

    steps:

      - run:
          name: Install software
          command: |
            apk update
            apk add python3
            python3 --version
            pip3 install pyyaml

      - checkout
      - run:
          name: Checkout vsi_common
          command: |
            git clone --recursive https://github.com/VisionSystemsInc/vsi_common.git /vsi

      - setup_remote_docker

      - run:
          name: Additional setup
          command: |
            sed -i 's|context: ../..|context: ${VSI_COMMON_DIR}|' docker-compose.yml
            docker login -u "${DOCKER_USER}" -p "${DOCKER_PASS}"

      - ci_load:
          step_name: Build recipes (ci_load)
          compose_file: ./docker-compose.yml

      - ci_load:
          step_name: Build tests (ci_load)
          compose_file: ./tests/docker-compose.yml

      - run:
          name: Run integration tests
          environment:
            TESTLIB_DISCOVERY_DIR: /root/repo/tests
          command: |
            "${VSI_COMMON_DIR}/tests/run_tests"

# -----
# CircleCI workflows
# -----
workflows:
  recipes:
    jobs:
      - build_and_test
